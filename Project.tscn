[gd_scene load_steps=23 format=2]

[ext_resource path="res://Levels/Hub/Hub.tscn" type="PackedScene" id=1]
[ext_resource path="res://shaders/CircleTransition.shader" type="Shader" id=2]
[ext_resource path="res://GameObjects/UI/AmmoCounter.tscn" type="PackedScene" id=6]
[ext_resource path="res://GUI.gd" type="Script" id=9]
[ext_resource path="res://Player.tscn" type="PackedScene" id=15]
[ext_resource path="res://Crosshair.tscn" type="PackedScene" id=18]
[ext_resource path="res://Text.tscn" type="PackedScene" id=24]
[ext_resource path="res://Trigger.tscn" type="PackedScene" id=28]
[ext_resource path="res://CutsceneTrigger.gd" type="Script" id=29]

[sub_resource type="Environment" id=34]
background_mode = 4
background_color = Color( 0.52549, 0.0117647, 0.0117647, 1 )
tonemap_white = 7.3
ssao_radius = 0.1
ssao_intensity = 13.61
ssao_radius2 = 61.09
ssao_intensity2 = 50.45
glow_enabled = true
glow_levels/3 = false
glow_levels/7 = true
glow_intensity = 0.31
glow_strength = 1.23
glow_hdr_scale = 0.0
glow_high_quality = true
adjustment_brightness = 1.06
adjustment_saturation = 1.23

[sub_resource type="Shader" id=35]
code = "shader_type canvas_item;
render_mode unshaded;

uniform int iterations = 20;
uniform float formuparam = 1.00;

uniform int volsteps = 20;
uniform float stepsize = 0.1;

uniform float zoom = 0.800;
uniform float tile = 0.5;
uniform float speed = 0.001;

uniform float brightness = 0.002;
uniform float darkmatter = 0.100;
uniform float distfading = 0.650;
uniform float saturation = 0.750;

uniform vec2 iResolution = vec2(192, 192);
uniform vec2 iMouse = vec2(0,0);

float SCurve (float value) {

    if (value < 0.5)
    {
        return value * value * value * value * value * 16.0; 
    }
    
    value -= 1.0;
    
    return value * value * value * value * value * 16.0 + 1.0;
}

void fragment()
{
	//get coords and direction
	vec2 uv=FRAGCOORD.xy/iResolution.xy-.5;
	uv.y*=iResolution.y/iResolution.x;
	vec3 dir=vec3(uv*zoom,1.);
	float time=TIME*speed+.25;

	//mouse rotation
	float a1=0.5+iMouse.x/iResolution.x*2.;
	float a2=0.8+iMouse.y/iResolution.y*2.;
	mat2 rot1=mat2(vec2(cos(a1),sin(a1)),vec2(-sin(a1),cos(a1)));
	mat2 rot2=mat2(vec2(cos(a2),sin(a2)),vec2(-sin(a2),cos(a2)));
	dir.xy*=rot1;
	dir.xz*=rot2;
	vec3 from=vec3(1.0,0.5,0.5);
	from-=vec3(0.0,time,0.0);
	from.xz*=rot1;
	from.xy*=rot2;
	
	//volumetric rendering
	float s=0.1,fade=1.;
	vec3 v=vec3(0.);
	for (int r=0; r<volsteps; r++) {
		vec3 p=from+s*dir*0.5;
		p = abs(vec3(tile)-mod(p,vec3(tile*2.))); // tiling fold
		float pa,a=pa=0.;
		for (int i=0; i<iterations; i++) { 
			p=abs(p)/dot(p,p)-formuparam; // the magic formula
			a+=abs(length(p)-pa); // absolute sum of average change
			pa=length(p);
		}
		float dm=max(0.,darkmatter-a*a*.001); //dark matter
		a = pow(a, 2.3); // add contrast
		if (r>6) fade*=1.-dm; // dark matter, don't render near
		//v+=vec3(dm,dm*.5,0.);
		v+=fade;
		v+=vec3(s,s*s,s*s*s*s)*a*brightness*fade; // coloring based on distance
		fade*=distfading; // distance fading
		s+=stepsize;
	}
    
	v=mix(vec3(length(v)),v,saturation); //color adjust
    
    vec4 C = vec4(v*.01,1.);
    
     	C.r = pow(C.r, 0.35); 
 	 	C.g = pow(C.g, 0.36); 
 	 	C.b = pow(C.b, 0.38); 
 	
    vec4 L = C;   	
    
    COLOR.r = mix(L.r, SCurve(C.r), 0.7); 
    COLOR.g = mix(L.g, SCurve(C.g), 1.0); 
    COLOR.b = mix(L.b, SCurve(C.b), 0.2);     	
	
}"

[sub_resource type="ShaderMaterial" id=9]
shader = SubResource( 35 )
shader_param/iterations = 20
shader_param/formuparam = 1.0
shader_param/volsteps = 20
shader_param/stepsize = 0.1
shader_param/zoom = 0.8
shader_param/tile = 0.5
shader_param/speed = 0.001
shader_param/brightness = 0.002
shader_param/darkmatter = 0.1
shader_param/distfading = 0.65
shader_param/saturation = 0.75
shader_param/iResolution = Vector2( 192, 192 )
shader_param/iMouse = Vector2( 0, 0 )

[sub_resource type="ShaderMaterial" id=29]
shader = ExtResource( 2 )
shader_param/circle_size = 1.05
shader_param/screen_width = 680.0
shader_param/screen_height = 414.0

[sub_resource type="DynamicFontData" id=37]
resource_local_to_scene = true
font_path = "res://fonts/7pxMONOkeychainn.ttf"

[sub_resource type="DynamicFont" id=38]
resource_local_to_scene = true
use_mipmaps = true
font_data = SubResource( 37 )

[sub_resource type="ShaderMaterial" id=36]
shader = ExtResource( 2 )
shader_param/circle_size = 0.455
shader_param/screen_width = 17.0
shader_param/screen_height = 10.0

[sub_resource type="Animation" id=16]
resource_name = "Cutscene1"
length = 2.0

[sub_resource type="Animation" id=17]
length = 0.001

[sub_resource type="RectangleShape2D" id=15]
extents = Vector2( 25, 45 )

[sub_resource type="Animation" id=30]
length = 0.001
tracks/0/type = "value"
tracks/0/path = NodePath("ForegroundLayer/Foreground:material:shader_param/circle_size")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0 ),
"transitions": PoolRealArray( 1 ),
"update": 0,
"values": [ 1.05 ]
}

[sub_resource type="Animation" id=31]
resource_name = "SCENE_TRANSITION_IN"
length = 0.9
step = 0.05
tracks/0/type = "value"
tracks/0/path = NodePath("ForegroundLayer/Foreground:material:shader_param/circle_size")
tracks/0/interp = 2
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0, 0.1, 0.85 ),
"transitions": PoolRealArray( 1, 1, 1 ),
"update": 0,
"values": [ 1.05, 1.05, 0.0 ]
}

[sub_resource type="Animation" id=32]
resource_name = "SCENE_TRANSITION_OUT"
length = 0.9
step = 0.05
tracks/0/type = "value"
tracks/0/path = NodePath("ForegroundLayer/Foreground:material:shader_param/circle_size")
tracks/0/interp = 2
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0, 0.1, 0.85 ),
"transitions": PoolRealArray( 1, 1, 1 ),
"update": 0,
"values": [ 0.0, 0.0, 1.05 ]
}

[node name="World" type="Node2D"]

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
environment = SubResource( 34 )

[node name="BackgroundLayer" type="CanvasLayer" parent="."]
layer = -1
visible = false

[node name="Background" type="ColorRect" parent="BackgroundLayer"]
show_behind_parent = true
material = SubResource( 9 )
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
margin_left = -512.0
margin_top = -288.0
margin_right = 516.0
margin_bottom = 288.0

[node name="ForegroundLayer" type="CanvasLayer" parent="."]
scale = Vector2( 2.15, 2.15 )
transform = Transform2D( 2.15, 0, 0, 2.15, 0, 0 )

[node name="Foreground" type="ColorRect" parent="ForegroundLayer"]
material = SubResource( 29 )
margin_right = 477.0
margin_bottom = 280.0
color = Color( 0, 0, 0, 1 )

[node name="CanvasLayer" type="CanvasLayer" parent="ForegroundLayer"]
scale = Vector2( 4, 4 )
transform = Transform2D( 4, 0, 0, 4, 0, 0 )

[node name="FPS" parent="ForegroundLayer/CanvasLayer" instance=ExtResource( 24 )]
margin_left = 1.75
margin_top = -2.0
margin_right = 37.75
margin_bottom = 12.0
grow_horizontal = 0
grow_vertical = 0
rect_scale = Vector2( 1, 1 )
custom_colors/default_color = Color( 0.219608, 0.8, 0.556863, 1 )
custom_fonts/normal_font = SubResource( 38 )
bbcode_text = "[color=#ffffffff]60[/color]"
text = "60"
content = "60"
color = Color( 1, 1, 1, 1 )
centered = false

[node name="AmmoCounter" parent="ForegroundLayer/CanvasLayer" instance=ExtResource( 6 )]
position = Vector2( 2.25, 12 )

[node name="GUI" type="Control" parent="ForegroundLayer"]
margin_left = 114.884
margin_top = 129.767
margin_right = 370.884
margin_bottom = 279.767
script = ExtResource( 9 )

[node name="HealthBarBg" type="ColorRect" parent="ForegroundLayer/GUI"]
margin_left = 42.0
margin_top = 137.0
margin_right = 214.0
margin_bottom = 144.0
rect_pivot_offset = Vector2( 86, 3 )
color = Color( 0.270588, 0.270588, 0.270588, 0.827451 )

[node name="HealthBar" type="ColorRect" parent="ForegroundLayer/GUI"]
margin_left = 42.0
margin_top = 137.0
margin_right = 214.0
margin_bottom = 144.0
color = Color( 0.654902, 0.054902, 0.054902, 1 )

[node name="ColorRect" type="ColorRect" parent="ForegroundLayer"]
visible = false
material = SubResource( 36 )
margin_right = 478.0
margin_bottom = 280.0
color = Color( 0.0313726, 1, 0, 1 )

[node name="Level" parent="." instance=ExtResource( 1 )]

[node name="TheEntity" parent="Level/YSort" index="0"]
frame = 0

[node name="Player" parent="Level/YSort" index="1" instance=ExtResource( 15 )]
position = Vector2( 77, -104 )

[node name="Crosshair" parent="." instance=ExtResource( 18 )]

[node name="Cutscenes" type="AnimationPlayer" parent="."]
anims/Cutscene1 = SubResource( 16 )
anims/RESET = SubResource( 17 )

[node name="CutsceneTrigger" parent="." instance=ExtResource( 28 )]
visible = false
position = Vector2( 223, -748 )
script = ExtResource( 29 )

[node name="CollisionShape2D" parent="CutsceneTrigger" index="0"]
position = Vector2( -14, -4 )
shape = SubResource( 15 )
disabled = true

[node name="GlobalAnimationPlayer" type="AnimationPlayer" parent="."]
anims/RESET = SubResource( 30 )
anims/SCENE_TRANSITION_IN = SubResource( 31 )
anims/SCENE_TRANSITION_OUT = SubResource( 32 )

[connection signal="shoot" from="Level/YSort/Player" to="ForegroundLayer/CanvasLayer/AmmoCounter" method="_on_Player_shoot"]
[connection signal="body_entered" from="CutsceneTrigger" to="CutsceneTrigger" method="_on_CutsceneTrigger_body_entered"]

[editable path="Level"]
[editable path="CutsceneTrigger"]
